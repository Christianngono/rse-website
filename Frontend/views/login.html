<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de bord RSE</title>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 600px; margin: auto; }
    input, button { display: block; margin: 1em 0; padding: 0.5em; width: 100%; }
    #token, #rapport, #audit { background: #f0f0f0; padding: 1em; white-space: pre-wrap; word-break: break-word; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>ğŸ” Connexion</h2>
  <input id="username" placeholder="Nom dâ€™utilisateur" />
  <input id="password" type="password" placeholder="Mot de passe" />
  <button onclick="login()">Se connecter</button>

  <h3>ğŸ« Token JWT :</h3>
  <pre id="token"></pre>

  <h3>ğŸ“‹ Actions sÃ©curisÃ©es :</h3>
  <button onclick="fetchRapport()">ğŸ“„ Afficher le rapport HTML</button>
  <button onclick="downloadPDF()">ğŸ“¥ TÃ©lÃ©charger PDF</button>
  <button onclick="downloadExcel()">ğŸ“Š TÃ©lÃ©charger Excel</button>
  <button onclick="fetchAudit()">ğŸ” Voir le rapport dâ€™audit</button>
  <button onclick="runSecureBuild()">ğŸ› ï¸ Secure Build</button>
  <button onclick="showAudit()">ğŸ” Voir le rapport dâ€™audit</button>
  <pre id="audit"></pre>

  <div id="loader" style="display:none;">
    <svg width="50" height="50" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="40" stroke="#00bfff" stroke-width="4" fill="none" stroke-dasharray="250" stroke-dashoffset="250">
        <animate attributeName="stroke-dashoffset" values="250;0" dur="2s" repeatCount="indefinite" />
      </circle>
    </svg>
    <svg id="transitionWave" viewBox="0 0 1440 320" preserveAspectRatio="none" style="width:100%; height:80px;">
      <path fill="#00bfff" fill-opacity="0.3" d="M0,160L80,165.3C160,171,320,181,480,176C640,171,800,149,960,144C1120,139,1280,149,1360,154.7L1440,160L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z">
        <animate attributeName="d" dur="3s" repeatCount="indefinite"
          values="
            M0,160L80,165.3C160,171,320,181,480,176C640,171,800,149,960,144C1120,139,1280,149,1360,154.7L1440,160L1440,320L0,320Z;
            M0,180L80,185.3C160,191,320,201,480,196C640,191,800,169,960,164C1120,159,1280,169,1360,174.7L1440,180L1440,320L0,320Z;
            M0,160L80,165.3C160,171,320,181,480,176C640,171,800,149,960,144C1120,139,1280,149,1360,154.7L1440,160L1440,320L0,320Z
          " />
      </path>
    </svg>
  </div>

  <h3>ğŸ“„ Rapport HTML :</h3>
  <div id="rapport"></div>

  <h3>ğŸ” Rapport dâ€™audit :</h3>
  <pre id="audit"></pre>

  <div id="sidebarToggle" onclick="toggleSidebar()">ğŸ“‚</div>
  <div id="sidebar">
    <h3>ğŸ“¡ Logs en direct</h3>
    <pre id="logs">Aucun log pour lâ€™instant...</pre>
  </div>
  
  <script type="module">
  import { toggleSidebar, showSection } from './js/ui/dashboardUI.js';
  import { fetchAudit } from './js/audit.js';

  async function showAudit() {
    const txt = await fetchAudit();
    document.getElementById('audit').textContent = txt;
  }

    async function login() {
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: document.getElementById('username').value,
          password: document.getElementById('password').value
        })
      });

      const data = await res.json();
      if (data.token) {
        localStorage.setItem('jwt', data.token);
        document.getElementById('token').textContent = data.token;
      } else {
        document.getElementById('token').textContent = data.error;
      }
    }

    async function fetchRapport() {
      const token = localStorage.getItem('jwt');
      const res = await fetch('/rapport-jwt', {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (res.ok) {
        const html = await res.text();
        document.getElementById('rapport').innerHTML = html;
      } else {
        document.getElementById('rapport').textContent = 'â›” AccÃ¨s refusÃ©';
      }
    }

    function downloadPDF() {
      window.open('/rapport-pdf', '_blank');
    }

    function downloadExcel() {
      const token = localStorage.getItem('jwt');
      window.open(`/export-excel?token=${token}`, '_blank');
    }

    async function fetchAudit() {
      const token = localStorage.getItem('jwt');
      const res = await fetch('/audit', {
        headers: { Authorization: `Bearer ${token}` }
      });

      const txt = await res.text();
      document.getElementById('audit').textContent = txt;
    }

    async function runSecureBuild() {
      document.getElementById('loader').style.display = 'block';
      const res = await fetch('/run?script=secure-build');
      const output = await res.text();
      document.getElementById('loader').style.display = 'none';
      document.getElementById('logs').textContent = output;
      document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
    }
  </script>
</body>
</html>